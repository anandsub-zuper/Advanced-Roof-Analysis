<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roof Intelligence Tester</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { display: flex; flex-direction: column; gap: 20px; }
        .preview { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        .preview img { width: 150px; height: 150px; object-fit: cover; border: 1px solid #ddd; }
        .status { margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 4px; }
        .results { white-space: pre-wrap; background: #f5f5f5; padding: 15px; border-radius: 4px; overflow: auto; max-height: 500px; }
        button { padding: 10px 15px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #cccccc; }
        progress { width: 100%; }
    </style>
</head>
<body>
    <h1>Roof Intelligence API Tester</h1>
    <div class="container">
        <div>
            <h3>Upload Roof Images (Max 15)</h3>
            <input type="file" id="imageInput" multiple accept="image/*">
            <div class="preview" id="imagePreview"></div>
        </div>
        
        <button id="analyzeBtn" onclick="analyzeRoof()">Analyze Roof</button>
        
        <div class="status" id="status">Ready to analyze. Please select images.</div>
        
        <div id="progressContainer" style="display: none;">
            <p>Analysis in progress. This may take 1-2 minutes...</p>
            <progress id="progressBar" value="0" max="100"></progress>
        </div>
        
        <div id="resultsContainer" style="display: none;">
            <h3>Analysis Results</h3>
            <div class="results" id="results"></div>
        </div>
    </div>

    <script>
        // Update this to your Heroku URL
        const API_URL = 'https://roof-intelligence-6a30489ce677.herokuapp.com';
        let selectedImages = [];
        
        document.getElementById('imageInput').addEventListener('change', previewImages);
        
        function previewImages(event) {
            const files = event.target.files;
            selectedImages = Array.from(files);
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            if (selectedImages.length > 15) {
                alert('Maximum 15 images allowed. Only the first 15 will be processed.');
                selectedImages = selectedImages.slice(0, 15);
            }
            
            selectedImages.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    preview.appendChild(img);
                }
                reader.readAsDataURL(file);
            });
            
            document.getElementById('status').textContent = `Ready to analyze ${selectedImages.length} images.`;
            document.getElementById('analyzeBtn').disabled = selectedImages.length === 0;
        }
        
        async function analyzeRoof() {
            if (selectedImages.length === 0) {
                alert('Please select at least one image');
                return;
            }
            
            // Show progress
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('status').textContent = 'Converting images...';
            
            // Convert images to base64
            const images = [];
            let progress = 0;
            
            for (let i = 0; i < selectedImages.length; i++) {
                const file = selectedImages[i];
                const base64 = await fileToBase64(file);
                images.push(base64.split(',')[1]); // Remove data URL prefix
                
                progress = ((i + 1) / selectedImages.length) * 50; // First 50% is image processing
                document.getElementById('progressBar').value = progress;
            }
            
            document.getElementById('status').textContent = 'Sending images to API for analysis...';
            
            try {
                const startTime = Date.now();
                const response = await fetch(`${API_URL}/api/analyze-roof-multiple`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ images })
                });
                
                if (!response.ok) {
                    throw new Error(`API returned status ${response.status}`);
                }
                
                const data = await response.json();
                const endTime = Date.now();
                
                document.getElementById('progressBar').value = 100;
                document.getElementById('status').textContent = `Analysis complete in ${((endTime - startTime) / 1000).toFixed(1)} seconds.`;
                document.getElementById('results').textContent = JSON.stringify(data, null, 2);
                document.getElementById('resultsContainer').style.display = 'block';
            } catch (error) {
                document.getElementById('status').textContent = `Error: ${error.message}`;
                document.getElementById('results').textContent = error.stack || error.message;
                document.getElementById('resultsContainer').style.display = 'block';
            } finally {
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('analyzeBtn').disabled = false;
            }
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // Check API status on load
        fetch(`${API_URL}/api-status`)
            .then(response => response.json())
            .then(data => {
                const statusEl = document.getElementById('status');
                if (data.apiKeyConfigured.startsWith('Yes')) {
                    statusEl.textContent = 'API ready. Please select images to analyze.';
                    statusEl.style.color = 'green';
                } else {
                    statusEl.textContent = 'Warning: OpenAI API key not configured on server.';
                    statusEl.style.color = 'red';
                }
            })
            .catch(error => {
                document.getElementById('status').textContent = `Cannot connect to API: ${error.message}`;
                document.getElementById('status').style.color = 'red';
            });
    </script>
</body>
</html>
